{
  "openapi": "3.0.3",
  "info": {
    "title": "Upload CDN API",
    "description": "API para upload de arquivos para DigitalOcean Spaces (CDN). Suporta vídeos, imagens e documentos. Todos os arquivos são armazenados com nomes únicos e retornam URLs públicas.",
    "version": "1.0.0",
    "contact": {
      "name": "Suporte API",
      "email": "suporte@exemplo.com"
    }
  },
  "servers": [
    {
      "url": "/",
      "description": "Servidor atual (mesma origem)"
    }
  ],
  "tags": [
    {
      "name": "Informações",
      "description": "Endpoints de informações sobre a API"
    },
    {
      "name": "Health Check",
      "description": "Verificação de status da API"
    },
    {
      "name": "Upload",
      "description": "Upload de arquivos para o CDN"
    }
  ],
  "paths": {
    "/": {
      "get": {
        "tags": ["Informações"],
        "summary": "Informações da API",
        "description": "Retorna informações sobre a API, endpoints disponíveis e formatos suportados.",
        "operationId": "getApiInfo",
        "responses": {
          "200": {
            "description": "Informações da API retornadas com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiInfo"
                },
                "example": {
                  "message": "Upload CDN API",
                  "version": "1.0.0",
                  "endpoints": {
                    "POST /upload": "Upload de arquivos",
                    "GET /health": "Status da API",
                    "GET /": "Informações da API"
                  },
                  "supported_formats": ["mp4", "avi", "mov", "mkv", "webm", "jpg", "jpeg", "png", "gif", "pdf", "doc", "docx"]
                }
              }
            }
          }
        }
      }
    },
    "/health": {
      "get": {
        "tags": ["Health Check"],
        "summary": "Verificar status da API",
        "description": "Endpoint de health check para verificar se a API está funcionando corretamente. Retorna o status atual e timestamp.",
        "operationId": "healthCheck",
        "responses": {
          "200": {
            "description": "API está funcionando corretamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                },
                "example": {
                  "status": "healthy",
                  "timestamp": "2024-01-15T10:30:00.123456",
                  "service": "upload-cdn-api"
                }
              }
            }
          },
          "503": {
            "description": "Serviço indisponível",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "success": false,
                  "error": "Serviço temporariamente indisponível",
                  "detail": "Não foi possível conectar ao serviço de armazenamento"
                }
              }
            }
          }
        }
      }
    },
    "/upload": {
      "post": {
        "tags": ["Upload"],
        "summary": "Upload de arquivo",
        "description": "Faz upload de um arquivo para o DigitalOcean Spaces. O arquivo recebe um nome único (UUID) e retorna a URL pública para acesso. Tipos de arquivo suportados: vídeos (mp4, avi, mov, mkv, webm), imagens (jpg, jpeg, png, gif) e documentos (pdf, doc, docx).",
        "operationId": "uploadFile",
        "requestBody": {
          "required": true,
          "description": "Arquivo a ser enviado. Deve ser um arquivo válido dentro dos tipos permitidos e dentro do tamanho máximo configurado.",
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "required": ["file"],
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "Arquivo a ser enviado. Tipos permitidos: mp4, avi, mov, mkv, webm, jpg, jpeg, png, gif, pdf, doc, docx"
                  },
                  "folder": {
                    "type": "string",
                    "description": "Subdiretório opcional onde o arquivo será armazenado (ex.: campanhas/2025/11, marketing/black-friday). Se não fornecido, usa o diretório padrão configurado. Caracteres permitidos: letras, números, hífen, underscore e barras.",
                    "example": "marketing/black-friday"
                  }
                }
              },
              "encoding": {
                "file": {
                  "contentType": "application/octet-stream"
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Upload realizado com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UploadSuccessResponse"
                },
                "examples": {
                  "video": {
                    "summary": "Upload de vídeo com resposta enriquecida",
                    "value": {
                      "success": true,
                      "arquivo": {
                        "id": "c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4",
                        "nome_original": "meu_video.mp4",
                        "nome_armazenado": "c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4",
                        "hash_md5": "d41d8cd98f00b204e9800998ecf8427e",
                        "tamanho": {
                          "bytes": 1320220,
                          "kilobytes": 1289.28,
                          "megabytes": 1.26,
                          "gigabytes": 0.0012,
                          "formatted": "1.26 MB",
                          "descricao_humana": "1.26 megabytes"
                        },
                        "tipo_mime": "video/mp4",
                        "extensao": "mp4",
                        "categoria": {
                          "categoria": "video",
                          "categoria_descricao": "Vídeo",
                          "tipo_midia": "Áudio e Vídeo",
                          "extensao": "mp4"
                        },
                        "diretorio": "uploads",
                        "caminho_completo": "uploads/c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4",
                        "url_publica": "https://cod5.nyc3.digitaloceanspaces.com/uploads/c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4",
                        "url_cdn": "https://cod5.nyc3.digitaloceanspaces.com/uploads/c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4",
                        "descricao_humana": "Arquivo vídeo 'meu_video.mp4' (1.26 megabytes)",
                        "midia": {
                          "duracao_segundos": 12.345,
                          "duracao_formatada": "00:00:12.345",
                          "bitrate_total_bps": 4800000,
                          "bitrate_total_mbps": 4.8,
                          "compressao": "VBR",
                          "codec_video": "h264",
                          "resolucao": "1920x1080",
                          "largura": 1920,
                          "altura": 1080,
                          "fps": 29.97,
                          "frames_estimados": 370,
                          "proporcao_aspecto": "16:9",
                          "pixel_format": "yuv420p",
                          "codec_audio": "aac",
                          "sample_rate": 48000,
                          "canais": 2,
                          "bitrate_audio": 128000,
                          "descricao_humana": "Vídeo 1920x1080 em h264, áudio aac, 00:00:12.345, 4.80 Mbps"
                        }
                      },
                      "sessao": {
                        "id_sessao": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                        "ip_cliente": "192.168.1.100",
                        "ip_original": "192.168.1.100",
                        "user_agent": "Mozilla/5.0...",
                        "referer": "",
                        "idioma_preferido": "pt-BR,pt;q=0.9",
                        "headers": {},
                        "descricao_humana": "Requisição de 192.168.1.100 via Mozilla/5.0..."
                      },
                      "upload": {
                        "timestamp_inicio": "2024-01-15T10:30:00.123456",
                        "timestamp_inicio_unix": 1705315800.123,
                        "timestamp_fim": "2024-01-15T10:30:02.456789",
                        "timestamp_fim_unix": 1705315802.456,
                        "duracao_total": {
                          "segundos": 2.33,
                          "formatted": "2.33 s",
                          "descricao_humana": "2.33 segundos"
                        },
                        "duracao_upload": {
                          "segundos": 2.10,
                          "formatted": "2.10 s",
                          "descricao_humana": "2.10 segundos"
                        },
                        "velocidade_bytes_por_segundo": 628676.19,
                        "velocidade_mbps": 4.78,
                        "velocidade_formatted": "4.78 Mbps",
                        "status": "concluido",
                        "bucket": "cod5",
                        "regiao": "nyc3",
                        "endpoint": "https://nyc3.digitaloceanspaces.com",
                        "descricao_humana": "Upload concluído em 2.10 segundos com velocidade média de 4.78 Mbps"
                      },
                      "analytics": {
                        "id_transacao": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
                        "timestamp_processamento": "2024-01-15T10:30:02.456789",
                        "tamanho_bytes": 1320220,
                        "tamanho_mb": 1.259,
                        "duracao_segundos": 2.333,
                        "velocidade_mbps": 4.782,
                        "categoria_arquivo": "video",
                        "tipo_midia": "Áudio e Vídeo",
                        "hash_arquivo": "d41d8cd98f00b204e9800998ecf8427e",
                        "ip_cliente": "192.168.1.100",
                        "diretorio": "uploads",
                        "metrica_performance": {
                          "tempo_processamento_ms": 2333.33,
                          "tempo_upload_ms": 2100.00,
                          "throughput_bytes_per_sec": 628676.19,
                          "throughput_mbps": 4.782
                        }
                      },
                      "url": "https://cod5.nyc3.digitaloceanspaces.com/uploads/c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4",
                      "callback_url": "https://cod5.nyc3.digitaloceanspaces.com/uploads/c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.json",
                      "filename": "c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4",
                      "original_filename": "meu_video.mp4",
                      "size": 1320220,
                      "content_type": "video/mp4"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Erro de validação na requisição",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "sem_arquivo": {
                    "summary": "Nenhum arquivo fornecido",
                    "value": {
                      "success": false,
                      "error": "Nenhum arquivo fornecido",
                      "detail": "É necessário enviar um arquivo no campo 'file' usando multipart/form-data"
                    }
                  },
                  "arquivo_vazio": {
                    "summary": "Arquivo sem nome ou vazio",
                    "value": {
                      "success": false,
                      "error": "Arquivo sem nome ou vazio",
                      "detail": "O arquivo enviado não possui nome ou está vazio. Verifique se o arquivo foi selecionado corretamente."
                    }
                  },
                  "tipo_invalido": {
                    "summary": "Tipo de arquivo não permitido",
                    "value": {
                      "success": false,
                      "error": "Tipo de arquivo não permitido. Tipos aceitos: mp4, avi, mov, mkv, webm, jpg, jpeg, png, gif, pdf, doc, docx",
                      "detail": "O arquivo enviado não está em um formato suportado. Use apenas os tipos listados."
                    }
                  }
                }
              }
            }
          },
          "413": {
            "description": "Arquivo muito grande",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "success": false,
                  "error": "Arquivo muito grande",
                  "detail": "O tamanho do arquivo excede o limite máximo permitido. Tamanho máximo configurado: 100MB. Tamanho do arquivo enviado: 150MB"
                }
              }
            }
          },
          "503": {
            "description": "Serviço de armazenamento indisponível",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "spaces_indisponivel": {
                    "summary": "DigitalOcean Spaces fora do ar",
                    "value": {
                      "success": false,
                      "error": "Serviço de armazenamento temporariamente indisponível",
                      "detail": "Não foi possível conectar ao DigitalOcean Spaces. Tente novamente em alguns instantes."
                    }
                  },
                  "credenciais_invalidas": {
                    "summary": "Credenciais não configuradas",
                    "value": {
                      "success": false,
                      "error": "Credenciais do Spaces não configuradas",
                      "detail": "As variáveis de ambiente SPACES_KEY e SPACES_SECRET não estão configuradas corretamente."
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Erro interno do servidor",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "success": false,
                  "error": "Erro interno do servidor",
                  "detail": "Ocorreu um erro inesperado durante o processamento. Entre em contato com o suporte se o problema persistir."
                }
              }
            }
          }
        }
      }
    },
    "/docs": {
      "get": {
        "tags": [],
        "summary": "Documentação Swagger UI",
        "description": "Interface interativa de documentação da API usando Swagger UI",
        "operationId": "swaggerUI",
        "responses": {
          "200": {
            "description": "Interface Swagger UI carregada"
          }
        }
      }
    },
    "/swagger.json": {
      "get": {
        "tags": [],
        "summary": "Especificação OpenAPI",
        "description": "Retorna a especificação OpenAPI completa da API em formato JSON",
        "operationId": "swaggerJson",
        "responses": {
          "200": {
            "description": "Especificação OpenAPI retornada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "ApiInfo": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string",
            "description": "Nome da API",
            "example": "Upload CDN API"
          },
          "version": {
            "type": "string",
            "description": "Versão da API",
            "example": "1.0.0"
          },
          "endpoints": {
            "type": "object",
            "description": "Lista de endpoints disponíveis",
            "additionalProperties": {
              "type": "string"
            },
            "example": {
              "POST /upload": "Upload de arquivos",
              "GET /health": "Status da API",
              "GET /": "Informações da API"
            }
          },
          "supported_formats": {
            "type": "array",
            "description": "Formatos de arquivo suportados",
            "items": {
              "type": "string"
            },
            "example": ["mp4", "avi", "mov", "mkv", "webm", "jpg", "jpeg", "png", "gif", "pdf", "doc", "docx"]
          }
        },
        "required": ["message", "version", "endpoints", "supported_formats"]
      },
      "HealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "description": "Status da API",
            "enum": ["healthy", "unhealthy"],
            "example": "healthy"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp da verificação",
            "example": "2024-01-15T10:30:00.123456"
          },
          "service": {
            "type": "string",
            "description": "Nome do serviço",
            "example": "upload-cdn-api"
          }
        },
        "required": ["status", "timestamp", "service"]
      },
      "UploadSuccessResponse": {
        "type": "object",
        "description": "Resposta enriquecida com metadados detalhados do arquivo, sessão, upload e analytics",
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Indica se o upload foi bem-sucedido",
            "example": true
          },
          "arquivo": {
            "type": "object",
            "description": "Informações detalhadas do arquivo enviado",
            "properties": {
              "id": {"type": "string", "description": "ID único do arquivo (UUID)", "example": "c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4"},
              "nome_original": {"type": "string", "description": "Nome original do arquivo", "example": "meu_video.mp4"},
              "nome_armazenado": {"type": "string", "description": "Nome único gerado para armazenamento", "example": "c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4"},
              "hash_md5": {"type": "string", "description": "Hash MD5 do arquivo", "example": "d41d8cd98f00b204e9800998ecf8427e"},
              "tamanho": {
                "type": "object",
                "description": "Tamanho do arquivo em diferentes unidades",
                "properties": {
                  "bytes": {"type": "integer"},
                  "kilobytes": {"type": "number"},
                  "megabytes": {"type": "number"},
                  "gigabytes": {"type": "number"},
                  "formatted": {"type": "string"},
                  "descricao_humana": {"type": "string"}
                }
              },
              "tipo_mime": {"type": "string", "example": "video/mp4"},
              "extensao": {"type": "string", "example": "mp4"},
              "categoria": {
                "type": "object",
                "properties": {
                  "categoria": {"type": "string", "example": "video"},
                  "categoria_descricao": {"type": "string", "example": "Vídeo"},
                  "tipo_midia": {"type": "string", "example": "Áudio e Vídeo"},
                  "extensao": {"type": "string", "example": "mp4"}
                }
              },
              "diretorio": {"type": "string", "description": "Diretório onde o arquivo foi armazenado", "example": "uploads"},
              "caminho_completo": {"type": "string", "description": "Caminho completo no bucket (diretório + nome do arquivo)", "example": "uploads/c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4"},
              "url_publica": {"type": "string", "format": "uri"},
              "url_cdn": {"type": "string", "format": "uri"},
              "descricao_humana": {"type": "string", "example": "Arquivo vídeo 'meu_video.mp4' (1.26 megabytes)"},
              "midia": {
                "type": "object",
                "description": "Metadados de mídia extraídos (disponível apenas para vídeos e áudios)",
                "properties": {
                  "duracao_segundos": {"type": "number", "example": 12.345},
                  "duracao_formatada": {"type": "string", "example": "00:00:12.345"},
                  "bitrate_total_bps": {"type": "integer", "example": 4800000},
                  "bitrate_total_mbps": {"type": "number", "example": 4.8},
                  "compressao": {"type": "string", "example": "VBR"},
                  "codec_video": {"type": "string", "example": "h264"},
                  "resolucao": {"type": "string", "example": "1920x1080"},
                  "largura": {"type": "integer", "example": 1920},
                  "altura": {"type": "integer", "example": 1080},
                  "fps": {"type": "number", "example": 29.97},
                  "frames_estimados": {"type": "integer", "example": 370},
                  "proporcao_aspecto": {"type": "string", "example": "16:9"},
                  "pixel_format": {"type": "string", "example": "yuv420p"},
                  "codec_audio": {"type": "string", "example": "aac"},
                  "sample_rate": {"type": "integer", "example": 48000},
                  "canais": {"type": "integer", "example": 2},
                  "bitrate_audio": {"type": "integer", "example": 128000},
                  "descricao_humana": {"type": "string", "example": "Vídeo 1920x1080 em h264, áudio aac, 00:00:12.345, 4.80 Mbps"}
                }
              }
            }
          },
          "sessao": {
            "type": "object",
            "description": "Informações da sessão/cliente que fez o upload",
            "properties": {
              "id_sessao": {"type": "string", "description": "ID único da sessão"},
              "ip_cliente": {"type": "string", "description": "IP do cliente (considerando proxy)"},
              "ip_original": {"type": "string", "description": "IP original da requisição"},
              "user_agent": {"type": "string"},
              "referer": {"type": "string"},
              "idioma_preferido": {"type": "string"},
              "headers": {"type": "object"},
              "descricao_humana": {"type": "string"}
            }
          },
          "upload": {
            "type": "object",
            "description": "Informações detalhadas do processo de upload",
            "properties": {
              "timestamp_inicio": {"type": "string", "format": "date-time"},
              "timestamp_inicio_unix": {"type": "number"},
              "timestamp_fim": {"type": "string", "format": "date-time"},
              "timestamp_fim_unix": {"type": "number"},
              "duracao_total": {
                "type": "object",
                "properties": {
                  "segundos": {"type": "number"},
                  "formatted": {"type": "string"},
                  "descricao_humana": {"type": "string"}
                }
              },
              "duracao_upload": {
                "type": "object",
                "properties": {
                  "segundos": {"type": "number"},
                  "formatted": {"type": "string"},
                  "descricao_humana": {"type": "string"}
                }
              },
              "velocidade_bytes_por_segundo": {"type": "number"},
              "velocidade_mbps": {"type": "number"},
              "velocidade_formatted": {"type": "string"},
              "status": {"type": "string", "example": "concluido"},
              "bucket": {"type": "string"},
              "regiao": {"type": "string"},
              "endpoint": {"type": "string"},
              "descricao_humana": {"type": "string"}
            }
          },
          "analytics": {
            "type": "object",
            "description": "Dados para análise e dashboards (métricas de performance e marketing)",
            "properties": {
              "id_transacao": {"type": "string"},
              "timestamp_processamento": {"type": "string", "format": "date-time"},
              "tamanho_bytes": {"type": "integer"},
              "tamanho_mb": {"type": "number"},
              "duracao_segundos": {"type": "number"},
              "velocidade_mbps": {"type": "number"},
              "categoria_arquivo": {"type": "string"},
              "tipo_midia": {"type": "string"},
              "hash_arquivo": {"type": "string"},
              "ip_cliente": {"type": "string"},
              "diretorio": {"type": "string", "description": "Diretório onde o arquivo foi armazenado"},
              "metrica_performance": {
                "type": "object",
                "properties": {
                  "tempo_processamento_ms": {"type": "number"},
                  "tempo_upload_ms": {"type": "number"},
                  "throughput_bytes_per_sec": {"type": "number"},
                  "throughput_mbps": {"type": "number"}
                }
              }
            }
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "URL pública do arquivo (campo legado para compatibilidade)",
            "example": "https://cod5.nyc3.digitaloceanspaces.com/c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4"
          },
          "filename": {
            "type": "string",
            "description": "Nome único gerado (campo legado)",
            "example": "c2aa6f8b-fc41-4969-b1fd-85f8512e10e7.mp4"
          },
          "original_filename": {
            "type": "string",
            "description": "Nome original (campo legado)",
            "example": "meu_video.mp4"
          },
          "size": {
            "type": "integer",
            "description": "Tamanho em bytes (campo legado)",
            "example": 1320220
          },
          "content_type": {
            "type": "string",
            "description": "Tipo MIME (campo legado)",
            "example": "video/mp4"
          }
        },
        "required": ["success", "arquivo", "sessao", "upload", "analytics"]
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Indica se a operação foi bem-sucedida (sempre false em caso de erro)",
            "example": false
          },
          "error": {
            "type": "string",
            "description": "Mensagem de erro resumida",
            "example": "Tipo de arquivo não permitido"
          },
          "detail": {
            "type": "string",
            "description": "Detalhes adicionais sobre o erro, útil para debugging e orientação do usuário",
            "example": "O arquivo enviado não está em um formato suportado. Use apenas os tipos listados."
          }
        },
        "required": ["success", "error"]
      }
    }
  }
}

